<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Pomodoro</title>

    <!-- –°—Ç–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <link rel="stylesheet" href="/src/css/main.css" />

    <!-- –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∏–∫—Å –¥–ª—è –∫–æ–ª—ë—Å: –ø–æ–ª–æ—Å–∞ –ø–æ–≤–µ—Ä—Ö, —Å—Ç–∞—Ä–∞—è –ø–æ–ª–æ—Å–∞ —Å–∫—Ä—ã—Ç–∞ -->
    <style>
      .wheel ._selector {
        z-index: 3;
      }
      .wheel ul {
        position: relative;
        z-index: 1;
      }
      .wheel-highlight {
        display: none !important;
      }
    </style>

    <!-- –ü–æ–¥–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–≥–æ –º–æ–¥—É–ª—è –∫–æ–ª—ë—Å –Ω–∞ no-op -->
    <script type="importmap">
      {
        "imports": {
          "/src/js/wheels.js": "data:application/javascript,export function initWheels(){}"
        }
      }
    </script>
  </head>

  <body class="night">
    <main class="app" id="app">
      <header class="topbar">
        <div class="brand">üçÖ</div>
        <div class="actions">
          <button id="openAuth" class="icon-btn" aria-label="–í–æ–π—Ç–∏">üîê</button>
          <div id="authStatus" class="auth-status"></div>
          <button id="themeToggle" class="icon-btn" aria-label="–¢–µ–º–∞">üåô</button>
          <button id="openSettings" class="icon-btn" aria-label="–ú–µ–Ω—é">‚ò∞</button>
        </div>
      </header>

      <section class="stage" aria-live="polite">
        <button class="tomato" id="tomatoBtn" aria-label="–°—Ç–∞—Ä—Ç/–ü–∞—É–∑–∞" aria-pressed="false">
          <svg class="tomato__progress" viewBox="0 0 360 360" aria-hidden="true">
            <circle
              id="progressArc"
              cx="180"
              cy="180"
              r="168"
              fill="none"
              stroke="currentColor"
              stroke-width="10"
              stroke-linecap="round"
              style="transform: rotate(-90deg); transform-origin: 180px 180px"
            />
          </svg>
          <img class="tomato__img" src="./assets/img/tomato.png" alt="–ü–æ–º–∏–¥–æ—Ä" draggable="false" />
          <div class="tomato__shadow" aria-hidden="true"></div>
        </button>

        <div class="readout">
          <div id="time" class="time">25:00</div>
          <div id="phase" class="phase">–û—Ç–¥—ã—Ö–∞–µ–º üòå</div>
        </div>
      </section>

      <footer class="credit" aria-hidden="true"></footer>
    </main>

    <!-- –ú–µ–Ω—é (sidebar) -->
    <div id="sidebarBackdrop" class="sb-backdrop" aria-hidden="true"></div>
    <aside id="sidebar" class="sb" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" aria-hidden="true">
      <div class="sb__inner">
        <header class="sb__brand">
          <div class="logo">üçÖ</div>
          <div class="title"><strong>–ü–ª–∞–Ω –∑–∞–Ω—è—Ç–∏–π</strong><span>–Ω–∞—Å—Ç—Ä–æ–π –∏–ª–∏ –≤—ã–±–µ—Ä–∏</span></div>
        </header>

        <hr class="sb__divider" />

        <div class="seg" role="tablist" aria-label="–ü–ª–∞–Ω –∑–∞–Ω—è—Ç–∏–π">
          <button class="seg__btn is-active" data-mode="build" role="tab" aria-selected="true">
            –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
          </button>
          <button class="seg__btn" data-mode="pick" role="tab" aria-selected="false">
            –í—ã–±—Ä–∞—Ç—å
          </button>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê: –ù–ê–°–¢–†–û–ò–¢–¨ -->
        <section class="pane is-open" data-pane="build">
          <div class="wheels" aria-label="–ö–æ–ª—ë—Å–∏–∫–∏ –≤—ã–±–æ—Ä–∞">
            <div class="wheel-card">
              <div class="wheel-wrap">
                <div class="wheel-label">–§–æ–∫—É—Å</div>
                <div
                  class="wheel"
                  data-key="focus"
                  data-min="1"
                  data-max="180"
                  data-value="25"
                ></div>
              </div>
              <div class="wheel-wrap">
                <div class="wheel-label">–ü–µ—Ä–µ—Ä—ã–≤</div>
                <div class="wheel" data-key="break" data-min="1" data-max="60" data-value="5"></div>
              </div>
              <div class="wheel-wrap">
                <div class="wheel-label">–¶–∏–∫–ª—ã</div>
                <div
                  class="wheel"
                  data-key="cycles"
                  data-min="1"
                  data-max="20"
                  data-value="4"
                ></div>
              </div>

              <!-- –æ–±—â–∏–π –º–∞—Ä–∫–µ—Ä –≤—ã–±–æ—Ä–∞ –Ω–∞ —Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏ -->
              <div class="wheel-pill" aria-hidden="true"></div>
            </div>
          </div>

          <!-- –ú–æ—Å—Ç –¥–ª—è —Å—Ç–∞—Ä–æ–π –ª–æ–≥–∏–∫–∏ sidebar.js (—Å–∫—Ä—ã—Ç—ã–µ inputs) -->
          <div class="inputs-bridge hidden" aria-hidden="true">
            <div class="grid2">
              <label class="pill in"
                ><span>–§–æ–∫—É—Å, –º–∏–Ω</span
                ><input id="bFocus" type="number" min="1" max="180" step="1" value="25"
              /></label>
              <label class="pill in"
                ><span>–ü–µ—Ä–µ—Ä—ã–≤, –º–∏–Ω</span
                ><input id="bBreak" type="number" min="1" max="60" step="1" value="5"
              /></label>
            </div>
            <label class="pill in"
              ><span>–¶–∏–∫–ª—ã</span
              ><input id="bCycles" type="number" min="1" max="20" step="1" value="4"
            /></label>
          </div>

          <div class="plan__meta" id="bMeta">25/5 √ó4 ‚âà 120 –º–∏–Ω</div>
          <div id="bEditTag" class="edit-tag hidden">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: <b id="bEditName"></b></div>

          <div class="row-between">
            <button id="bApply" class="btn">‚ñ∂ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button id="bSaveToggle" class="btn ghost">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω</button>
          </div>

          <div id="bSaveBlock" class="save-row hidden">
            <label class="pill in"
              ><span>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞</span
              ><input id="bName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£—Ç—Ä–æ 2√ó25/5"
            /></label>
            <div class="row-between">
              <span class="plan__hint">–°–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ ¬´–ü–ª–∞–Ω—ã¬ª</span>
              <div class="row-between" style="gap: 8px">
                <button id="bCancelEdit" class="btn ghost hidden">–û—Ç–º–µ–Ω–∞</button>
                <button id="bSave" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </section>

        <!-- –í–ö–õ–ê–î–ö–ê: –í–´–ë–†–ê–¢–¨ -->
        <section class="pane" data-pane="pick">
          <div class="list scroll" id="listPlans"></div>
        </section>

        <div class="sb__spacer"></div>
        <div class="sb__footer">
          <button id="sbClose" class="sb__logout">‚úï <span>–ó–∞–∫—Ä—ã—Ç—å</span></button>
        </div>
      </div>
    </aside>

    <!-- AUTH MODAL -->
    <div id="authModal" class="auth-modal" aria-hidden="true">
      <div class="auth-dialog" role="dialog" aria-modal="true" aria-labelledby="authTitle">
        <header class="auth-head">
          <strong id="authTitle">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</strong>
          <button id="authClose" class="icon-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </header>

        <button
          id="loginGoogle"
          class="btn btn-google"
          type="button"
          aria-label="–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å Google"
        >
          <span class="g-logo" aria-hidden="true"></span>
          <span>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å Google</span>
        </button>

        <div class="or-row" aria-hidden="true"><span></span><em>–∏–ª–∏</em><span></span></div>

        <form id="authForm" class="auth-form" autocomplete="on">
          <label>Email <input id="authEmail" type="email" autocomplete="email" required /></label>
          <label
            >–ü–∞—Ä–æ–ª—å
            <input
              id="authPass"
              type="password"
              minlength="6"
              autocomplete="current-password"
              required
            />
          </label>
          <div class="row">
            <select id="authMode" aria-label="–†–µ–∂–∏–º">
              <option value="login">–í–æ–π—Ç–∏</option>
              <option value="signup">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</option>
            </select>
            <button type="submit" class="btn">OK</button>
          </div>
        </form>

        <footer class="auth-foot">
          <button id="logoutBtn" class="btn ghost">–í—ã–π—Ç–∏</button>
        </footer>
      </div>
    </div>

    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è iOS-–ø–æ–¥–æ–±–Ω—ã—Ö –∫–æ–ª—ë—Å + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è -->
    <script>
      (() => {
        const ROW_H = 40; // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å CSS
        const VISIBLE = 5;

        const idByKey = { focus: 'bFocus', break: 'bBreak', cycles: 'bCycles' };

        function pushToBridge(key, value) {
          const id = idByKey[key];
          const el = id && document.getElementById(id);
          if (!el) return;
          el.value = String(value);
          el.dispatchEvent(new Event('input', { bubbles: true }));
          el.dispatchEvent(new Event('change', { bubbles: true }));
        }

        function buildList(min, max) {
          const ul = document.createElement('ul');
          for (let v = min; v <= max; v++) {
            const li = document.createElement('li');
            li.dataset.val = v;
            li.textContent = v;
            ul.appendChild(li);
          }
          return ul;
        }

        // –±–ª–∏–∂–∞–π—à–∏–π –∏–Ω–¥–µ–∫—Å –∫ —Ü–µ–Ω—Ç—Ä—É: +0.5*ROW_H –¥–∞—ë—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é ¬´–æ–∫—Ä—É–≥–ª—ë–Ω–Ω–æ—Å—Ç—å¬ª
        function nearestValue(wheel, min, max) {
          const idx = Math.round(wheel.scrollTop / ROW_H);
          let val = min + idx;
          if (val < min) val = min;
          if (val > max) val = max;
          return val;
        }

        function scrollToVal(wheel, min, val, smooth = true) {
          const top = (val - min) * ROW_H;
          wheel.scrollTo({ top, behavior: smooth ? 'smooth' : 'auto' });
        }

        function markActive(wheel, min, val) {
          const nodes = wheel.querySelectorAll('li');
          nodes.forEach((n) => n.classList.remove('is-active'));
          const i = val - min;
          if (nodes[i]) nodes[i].classList.add('is-active');
        }

        function initOne(wheel) {
          const min = parseInt(wheel.dataset.min || '1', 10);
          const max = parseInt(wheel.dataset.max || '10', 10);
          const key = wheel.dataset.key;

          // —á–∏—Å—Ç–∏–º –∏ —Å—Ç—Ä–æ–∏–º —Å–ø–∏—Å–æ–∫
          wheel.innerHTML = '';
          wheel.appendChild(buildList(min, max));

          // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ inline-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤–¥—Ä—É–≥ –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏–ª—Å—è CSS)
          const pad = (ROW_H * VISIBLE - ROW_H) / 2;
          wheel.style.scrollSnapType = 'y mandatory';
          wheel.style.scrollPaddingTop = pad + 'px';
          wheel.style.scrollPaddingBottom = pad + 'px';

          let val = Math.min(max, Math.max(min, parseInt(wheel.dataset.value || String(min), 10)));
          scrollToVal(wheel, min, val, false);
          markActive(wheel, min, val);
          pushToBridge(key, val);

          // —Å–Ω–∞–ø –ø–æ—Å–ª–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (debounce)
          let t = null;
          wheel.addEventListener(
            'scroll',
            () => {
              if (t) cancelAnimationFrame(t);
              t = requestAnimationFrame(() => {
                const v = nearestValue(wheel, min, max);
                if (v !== val) {
                  val = v;
                  pushToBridge(key, v);
                }
                scrollToVal(wheel, min, v, true);
                markActive(wheel, min, v);
              });
            },
            { passive: true }
          );

          // –∫–ª–∏–∫–∏ –ø–æ —Å—Ç—Ä–æ–∫–∞–º
          wheel.addEventListener('click', (e) => {
            const li = e.target.closest('li[data-val]');
            if (!li) return;
            const v = parseInt(li.dataset.val, 10);
            val = v;
            scrollToVal(wheel, min, v, true);
            markActive(wheel, min, v);
            pushToBridge(key, v);
          });

          // –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
          wheel.tabIndex = 0;
          wheel.addEventListener('keydown', (e) => {
            let d = 0;
            if (e.key === 'ArrowUp') d = -1;
            else if (e.key === 'ArrowDown') d = 1;
            else if (e.key === 'PageUp') d = -5;
            else if (e.key === 'PageDown') d = 5;
            else if (e.key === 'Home') d = min - val;
            else if (e.key === 'End') d = max - val;
            else return;

            const next = Math.max(min, Math.min(max, val + d));
            val = next;
            scrollToVal(wheel, min, next, true);
            markActive(wheel, min, next);
            pushToBridge(key, next);
            e.preventDefault();
          });
        }

        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.wheel').forEach(initOne);
        });
      })();
    </script>

    <!-- –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <script type="module" src="./src/js/main.js"></script>
  </body>
</html>
